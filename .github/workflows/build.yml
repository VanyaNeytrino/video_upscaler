# .github/workflows/build.yml
name: Build Video Upscaler Multi-Platform

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [created]

env:
  FLUTTER_VERSION: '3.27.1'

jobs:
  # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –º–æ–¥–µ–ª–µ–π –ë–ï–ó Git LFS - —Ç–æ–ª—å–∫–æ —Å–∫—Ä–∏–ø—Ç
  prepare-models:
    name: Download AI Models
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: false  # –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∞–µ–º Git LFS

      - name: Create asset directories
        run: |
          echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è –º–æ–¥–µ–ª–µ–π..."
          mkdir -p assets/executables/{linux,windows,macos}/{models-cunet,models-upconv_7_anime_style_art_rgb,models-upconv_7_photo}

      - name: Download real model files via script
        run: |
          echo "üì• –°–∫–∞—á–∏–≤–∞–µ–º –ù–ê–°–¢–û–Ø–©–ò–ï —Ñ–∞–π–ª—ã –º–æ–¥–µ–ª–∏ —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç..."
          chmod +x download_real_models.sh
          ./download_real_models.sh

      # –ò–°–ü–†–ê–í–õ–ï–ù–ê –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è —É—á–µ—Ç–∞ ffmpeg.exe –Ω–∞ Windows
      - name: Verify downloaded models
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π:"
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
          echo "üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ assets/executables/:"
          find assets/executables/ -type f | head -20
          echo ""
          
          for platform in linux windows macos; do
            echo "üìÅ Platform: $platform"
            
            # –ò–°–ü–†–ê–í–õ–ï–ù–û: –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è FFmpeg –¥–ª—è –∫–∞–∂–¥–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
            ffmpeg_name="ffmpeg"
            if [ "$platform" = "windows" ]; then
              ffmpeg_name="ffmpeg.exe"
            fi
            
            echo "  –ò—â–µ–º: $ffmpeg_name"
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
            echo "  üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ assets/executables/$platform/:"
            ls -la "assets/executables/$platform/" | head -10
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º FFmpeg —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º
            if [ -f "assets/executables/$platform/$ffmpeg_name" ]; then
              size=$(stat -c%s "assets/executables/$platform/$ffmpeg_name" 2>/dev/null || echo "0")
              size_mb=$((size / 1024 / 1024))
              echo "  FFmpeg ($ffmpeg_name): ${size_mb}MB"
              
              if [ $size_mb -gt 50 ]; then
                echo "  ‚úÖ FFmpeg –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞"
              else
                echo "  ‚ùå FFmpeg —Å–ª–∏—à–∫–æ–º –º–∞–ª"
                exit 1
              fi
            else
              echo "  ‚ùå FFmpeg ($ffmpeg_name) –Ω–µ –Ω–∞–π–¥–µ–Ω"
              
              # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ exe —Ñ–∞–π–ª—ã –µ—Å–ª–∏ —ç—Ç–æ Windows
              if [ "$platform" = "windows" ]; then
                echo "  üîç –í—Å–µ .exe —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ:"
                find "assets/executables/$platform/" -name "*.exe" 2>/dev/null || echo "    –ù–µ—Ç .exe —Ñ–∞–π–ª–æ–≤"
              fi
              
              exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–¥–µ–ª–∏
            bin_count=$(find "assets/executables/$platform/" -name "*.bin" 2>/dev/null | wc -l)
            param_count=$(find "assets/executables/$platform/" -name "*.param" 2>/dev/null | wc -l)
            echo "  –ú–æ–¥–µ–ª–∏: ${bin_count} .bin, ${param_count} .param —Ñ–∞–π–ª–æ–≤"
            
            if [ $bin_count -eq 0 ] || [ $param_count -eq 0 ]; then
              echo "  ‚ùå –ú–æ–¥–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
              exit 1
            fi
            echo "---"
          done

      - name: Upload models as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ai-models
          path: assets/executables/
          retention-days: 1

  # –°–±–æ—Ä–∫–∞ –¥–ª—è –≤—Å–µ—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º
  build:
    name: Build ${{ matrix.platform }}
    needs: prepare-models
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            flutter-target: linux
            artifact-path: 'build/linux/x64/release/bundle'
            executable: 'video_upscaler'
          - os: windows-latest
            platform: windows
            flutter-target: windows
            artifact-path: 'build/windows/x64/runner/Release'
            executable: 'video_upscaler.exe'
          - os: macos-latest
            platform: macos
            flutter-target: macos
            artifact-path: 'build/macos/Build/Products/Release'
            executable: 'video_upscaler.app'

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download AI models
        uses: actions/download-artifact@v4
        with:
          name: ai-models
          path: assets/executables/

      # –ò–°–ü–†–ê–í–õ–ï–ù–ê –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è —É—á–µ—Ç–∞ ffmpeg.exe –Ω–∞ Windows
      - name: Verify models for platform
        shell: bash
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥–µ–ª–µ–π –¥–ª—è ${{ matrix.platform }}:"
          if [ -d "assets/executables/${{ matrix.platform }}" ]; then
            
            # –ò–°–ü–†–ê–í–õ–ï–ù–û: –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è FFmpeg
            ffmpeg_name="ffmpeg"
            if [ "${{ matrix.platform }}" = "windows" ]; then
              ffmpeg_name="ffmpeg.exe"
            fi
            
            echo "–ò—â–µ–º FFmpeg: $ffmpeg_name"
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            echo "üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ assets/executables/${{ matrix.platform }}/:"
            ls -la "assets/executables/${{ matrix.platform }}/"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º FFmpeg —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º
            if [ -f "assets/executables/${{ matrix.platform }}/$ffmpeg_name" ]; then
              size=$(stat -c%s "assets/executables/${{ matrix.platform }}/$ffmpeg_name" 2>/dev/null || stat -f%z "assets/executables/${{ matrix.platform }}/$ffmpeg_name" 2>/dev/null || echo "0")
              size_mb=$((size / 1024 / 1024))
              echo "FFmpeg ($ffmpeg_name): ${size_mb}MB"
              
              if [ $size_mb -gt 50 ]; then
                echo "‚úÖ FFmpeg –≤—ã–≥–ª—è–¥–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
              else
                echo "‚ùå FFmpeg —Å–ª–∏—à–∫–æ–º –º–∞–ª - –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ–º"
                exit 1
              fi
            else
              echo "‚ùå FFmpeg ($ffmpeg_name) –Ω–µ –Ω–∞–π–¥–µ–Ω"
              
              # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–ª—è Windows
              if [ "${{ matrix.platform }}" = "windows" ]; then
                echo "üîç –ü–æ–∏—Å–∫ –≤—Å–µ—Ö .exe —Ñ–∞–π–ª–æ–≤:"
                find "assets/executables/${{ matrix.platform }}/" -name "*.exe" 2>/dev/null || echo "–ù–µ—Ç .exe —Ñ–∞–π–ª–æ–≤"
                echo "üîç –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ —Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö 'ffmpeg':"
                find "assets/executables/${{ matrix.platform }}/" -name "*ffmpeg*" 2>/dev/null || echo "–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ —Å ffmpeg –≤ –∏–º–µ–Ω–∏"
              fi
              
              exit 1
            fi
            
            find "assets/executables/${{ matrix.platform }}/" -name "*.bin" | head -3
            find "assets/executables/${{ matrix.platform }}/" -name "*.param" | head -3
            echo "‚úÖ –ú–æ–¥–µ–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è ${{ matrix.platform }}"
          else
            echo "‚ùå –ú–æ–¥–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è ${{ matrix.platform }}"
            exit 1
          fi

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            libgtk-3-dev \
            libx11-dev \
            pkg-config \
            cmake \
            ninja-build \
            libblkid-dev \
            libsecret-1-dev \
            libjsoncpp-dev \
            clang \
            libglu1-mesa-dev \
            build-essential

      - name: Setup Windows environment
        if: matrix.platform == 'windows'
        uses: microsoft/setup-msbuild@v2

      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Analyze code
        run: flutter analyze --no-fatal-infos
        continue-on-error: true

      - name: Run tests
        run: flutter test
        continue-on-error: true

      - name: Enable desktop platform
        run: flutter config --enable-${{ matrix.flutter-target }}-desktop

      - name: Build application
        shell: bash
        run: |
          echo "üî® –°–±–æ—Ä–∫–∞ –¥–ª—è ${{ matrix.platform }}..."
          flutter build ${{ matrix.flutter-target }} --release --verbose
          
          echo "üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–±–æ—Ä–∫–∏:"
          if [ -e "${{ matrix.artifact-path }}/${{ matrix.executable }}" ]; then
            echo "‚úÖ –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω: ${{ matrix.executable }}"
            ls -lh "${{ matrix.artifact-path }}/${{ matrix.executable }}"
          else
            echo "‚ùå –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
            find build/ -name "*video_upscaler*" -o -name "*.exe" -o -name "*.app" || echo "–ü–æ–∏—Å–∫ –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"
            exit 1
          fi

      - name: Package build
        shell: bash
        run: |
          echo "üì¶ –£–ø–∞–∫–æ–≤–∫–∞ —Å–±–æ—Ä–∫–∏ –¥–ª—è ${{ matrix.platform }}..."
          
          if [[ "${{ matrix.platform }}" == "linux" ]]; then
            cd "${{ matrix.artifact-path }}"
            tar -czf ../../../../video_upscaler_linux_x64.tar.gz ./*
            cd ../../../../
            echo "‚úÖ Created: video_upscaler_linux_x64.tar.gz"
            ls -lh video_upscaler_linux_x64.tar.gz
            
          elif [[ "${{ matrix.platform }}" == "windows" ]]; then
            cd "${{ matrix.artifact-path }}"
            powershell -Command "Compress-Archive -Path './*' -DestinationPath '../../../../../video_upscaler_windows_x64.zip'"
            cd ../../../../../
            echo "‚úÖ Created: video_upscaler_windows_x64.zip"
            ls -lh video_upscaler_windows_x64.zip
            
          elif [[ "${{ matrix.platform }}" == "macos" ]]; then
            cd "${{ matrix.artifact-path }}"
            zip -r ../../../../../video_upscaler_macos.zip video_upscaler.app/
            cd ../../../../../
            echo "‚úÖ Created: video_upscaler_macos.zip"
            ls -lh video_upscaler_macos.zip
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: video-upscaler-${{ matrix.platform }}-build
          path: ${{ matrix.artifact-path }}
          retention-days: 30

      - name: Upload packaged artifacts
        uses: actions/upload-artifact@v4
        with:
          name: video-upscaler-${{ matrix.platform }}-package
          path: |
            video_upscaler_*.tar.gz
            video_upscaler_*.zip
          retention-days: 90
          if-no-files-found: error

  # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞
  release:
    name: Create Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all package artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: video-upscaler-*-package
          path: packages/
          merge-multiple: true

      - name: List release artifacts
        run: |
          echo "üì¶ –§–∞–π–ª—ã –¥–ª—è —Ä–µ–ª–∏–∑–∞:"
          find packages/ -type f -ls 2>/dev/null || echo "–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          ls -la packages/ 2>/dev/null || echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è packages –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: packages/*
          name: Video Upscaler ${{ github.ref_name }}
          body: |
            ## Video Upscaler ${{ github.ref_name }}
            
            ### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã:
            - üêß **Linux** (x64) - `video_upscaler_linux_x64.tar.gz`
            - ü™ü **Windows** (x64) - `video_upscaler_windows_x64.zip`
            - üçé **macOS** (Intel/Apple Silicon) - `video_upscaler_macos.zip`
            
            ### –£—Å—Ç–∞–Ω–æ–≤–∫–∞:
            1. –°–∫–∞—á–∞–π—Ç–µ –∞—Ä—Ö–∏–≤ –¥–ª—è –≤–∞—à–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
            2. –†–∞—Å–ø–∞–∫—É–π—Ç–µ –≤ —É–¥–æ–±–Ω—É—é –ø–∞–ø–∫—É
            3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª
            
            ### –ß—Ç–æ –Ω–æ–≤–æ–≥–æ:
            ${{ github.event.release.body }}
            
            ---
            –°–æ–±—Ä–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å –ø–æ–º–æ—â—å—é GitHub Actions üöÄ
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–æ–∫
  verify-builds:
    name: Verify All Builds
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: video-upscaler-*-build
          path: builds/

      - name: Verify build completeness
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã —Å–±–æ—Ä–æ–∫:"
          
          platforms=("linux" "windows" "macos")
          for platform in "${platforms[@]}"; do
            if find builds/ -name "*$platform*" -type d | grep -q .; then
              echo "‚úÖ –°–±–æ—Ä–∫–∞ –¥–ª—è $platform –Ω–∞–π–¥–µ–Ω–∞"
            else
              echo "‚ùå –°–±–æ—Ä–∫–∞ –¥–ª—è $platform –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
            fi
          done
          
          echo ""
          echo "üìä –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—Ä–∫–∞—Ö:"
          find builds/ -type f -name "*video_upscaler*" -o -name "*.exe" -o -name "*.app" | while read file; do
            if [ -f "$file" ]; then
              size=$(du -h "$file" | cut -f1)
              echo "  üìÑ $(basename "$file"): $size"
            fi
          done
