name: Build Multi-Platform
on: [push]

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: windows-latest
            platform: windows
          - os: macos-latest
            platform: macos
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        lfs: true  # Важно для Git LFS файлов
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.1'
        channel: 'stable'
    
    # КРИТИЧНО ДЛЯ LINUX: Установка GTK и зависимостей
    - name: Install Linux dependencies
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgtk-3-dev \
          libx11-dev \
          pkg-config \
          cmake \
          ninja-build \
          libblkid-dev \
          libsecret-1-dev \
          libjsoncpp-dev \
          clang
        
        # Проверяем что GTK найден
        pkg-config --modversion gtk+-3.0
        pkg-config --cflags gtk+-3.0
    
    # Для Windows: установка Visual Studio Build Tools
    - name: Setup Windows dependencies
      if: matrix.platform == 'windows'
      uses: microsoft/setup-msbuild@v1
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Build for platform
      run: |
        if [ "${{ matrix.platform }}" = "linux" ]; then
          flutter build linux --release
        elif [ "${{ matrix.platform }}" = "windows" ]; then
          flutter build windows --release
        elif [ "${{ matrix.platform }}" = "macos" ]; then
          flutter build macos --release
        fi
      shell: bash
    
    # Загрузка артефактов
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: video-upscaler-${{ matrix.platform }}
        path: |
          build/${{ matrix.platform }}/*/bundle/
          build/${{ matrix.platform }}/*/Release/
