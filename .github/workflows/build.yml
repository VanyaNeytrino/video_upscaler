name: Build Multi-Platform
on: 
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            flutter-platform: linux
          - os: windows-latest
            platform: windows
            flutter-platform: windows
          - os: macos-latest
            platform: macos
            flutter-platform: macos
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        lfs: true
        fetch-depth: 0
    
    # ПРИНУДИТЕЛЬНАЯ УСТАНОВКА ПОСЛЕДНЕЙ ВЕРСИИ FLUTTER
    - name: Setup Flutter (latest stable)
      run: |
        echo "Installing Flutter with Dart SDK >= 3.7.0..."
        
        if [[ "${{ runner.os }}" == "Linux" ]]; then
          echo "Installing Flutter for Linux..."
          wget -q -O flutter.tar.xz https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.27.1-stable.tar.xz
          tar xf flutter.tar.xz
          echo "$PWD/flutter/bin" >> $GITHUB_PATH
          export PATH="$PWD/flutter/bin:$PATH"
          
        elif [[ "${{ runner.os }}" == "macOS" ]]; then
          echo "Installing Flutter for macOS..."
          wget -q -O flutter.zip https://storage.googleapis.com/flutter_infra_release/releases/stable/macos/flutter_macos_3.27.1-stable.zip
          unzip -q flutter.zip
          echo "$PWD/flutter/bin" >> $GITHUB_PATH
          export PATH="$PWD/flutter/bin:$PATH"
          
        elif [[ "${{ runner.os }}" == "Windows" ]]; then
          echo "Installing Flutter for Windows..."
          curl -L -o flutter.zip https://storage.googleapis.com/flutter_infra_release/releases/stable/windows/flutter_windows_3.27.1-stable.zip
          7z x flutter.zip > NUL 2>&1
          echo "$PWD/flutter/bin" >> $GITHUB_PATH
          export PATH="$PWD/flutter/bin:$PATH"
        fi
        
        # Настройка Flutter
        flutter config --no-analytics
        flutter config --enable-web
        flutter precache --universal
      shell: bash
    
    # ПРОВЕРКА УСТАНОВКИ FLUTTER
    - name: Verify Flutter installation
      run: |
        echo "=== Flutter Installation Check ==="
        flutter --version
        echo ""
        echo "=== Dart Version Check ==="
        dart --version
        echo ""
        echo "=== Flutter Doctor ==="
        flutter doctor -v
        echo ""
        echo "=== Checking Dart SDK Version Compatibility ==="
        dart --version | grep -E "3\.[7-9]\.|3\.[1-9][0-9]\.|[4-9]\." && echo "✅ Dart SDK version is compatible" || echo "❌ Dart SDK version may be too old"
    
    # LINUX DEPENDENCIES
    - name: Install Linux dependencies
      if: matrix.platform == 'linux'
      run: |
        echo "Installing Linux dependencies..."
        sudo apt-get update -y
        sudo apt-get install -y \
          libgtk-3-dev \
          libx11-dev \
          pkg-config \
          cmake \
          ninja-build \
          libblkid-dev \
          libsecret-1-dev \
          libjsoncpp-dev \
          clang \
          libglu1-mesa-dev \
          libegl1-mesa-dev \
          libwayland-dev \
          xvfb \
          build-essential
        
        echo "Verifying GTK installation:"
        pkg-config --modversion gtk+-3.0
        pkg-config --cflags gtk+-3.0
    
    # WINDOWS DEPENDENCIES
    - name: Setup Windows dependencies
      if: matrix.platform == 'windows'
      run: |
        echo "Setting up Windows build environment..."
        where msbuild 2>NUL || echo "MSBuild not found in PATH"
      shell: cmd
    
    - name: Setup Windows MSBuild
      if: matrix.platform == 'windows'
      uses: microsoft/setup-msbuild@v2
    
    # MACOS DEPENDENCIES
    - name: Setup macOS dependencies
      if: matrix.platform == 'macos'
      run: |
        echo "Setting up macOS build environment..."
        xcode-select -p
        # Проверяем что Xcode Command Line Tools установлены
        if ! xcode-select -p &>/dev/null; then
          echo "Installing Xcode Command Line Tools..."
          xcode-select --install
          sleep 5
        fi
    
    # FLUTTER DEPENDENCIES
    - name: Get Flutter dependencies
      run: |
        echo "Getting Flutter dependencies..."
        echo "Current directory: $(pwd)"
        echo "pubspec.yaml content:"
        cat pubspec.yaml | head -20
        
        flutter pub get
        echo "✅ Dependencies installed successfully"
    
    # FLUTTER ANALYZE
    - name: Analyze Flutter code
      run: |
        echo "Analyzing Flutter code..."
        flutter analyze --no-fatal-infos
    
    # FLUTTER TEST
    - name: Run Flutter tests
      run: |
        echo "Running Flutter tests..."
        flutter test --no-sound-null-safety || echo "⚠️ Tests failed, continuing with build..."
    
    # BUILD APPLICATIONS
    - name: Build Flutter application
      run: |
        echo "Building Flutter application for ${{ matrix.platform }}..."
        
        if [[ "${{ matrix.platform }}" == "linux" ]]; then
          echo "Building for Linux..."
          flutter build linux --release --verbose
          
          echo "Checking Linux build output:"
          ls -la build/linux/x64/release/bundle/ || echo "Build directory not found"
          
        elif [[ "${{ matrix.platform }}" == "windows" ]]; then
          echo "Building for Windows..."
          flutter build windows --release --verbose
          
          echo "Checking Windows build output:"
          if [[ -d "build/windows/x64/runner/Release" ]]; then
            ls -la build/windows/x64/runner/Release/
          else
            echo "Windows build directory not found"
          fi
          
        elif [[ "${{ matrix.platform }}" == "macos" ]]; then
          echo "Building for macOS..."
          flutter build macos --release --verbose
          
          echo "Checking macOS build output:"
          ls -la build/macos/Build/Products/Release/ || echo "macOS build directory not found"
        fi
      shell: bash
    
    # VERIFY BUILD RESULTS
    - name: Verify build results
      run: |
        echo "Verifying build results for ${{ matrix.platform }}..."
        
        if [[ "${{ matrix.platform }}" == "linux" ]]; then
          if [[ -f "build/linux/x64/release/bundle/video_upscaler" ]]; then
            echo "✅ Linux executable found"
            file build/linux/x64/release/bundle/video_upscaler
            ls -lh build/linux/x64/release/bundle/video_upscaler
          else
            echo "❌ Linux executable not found"
            echo "Available files:"
            find build/ -name "*video_upscaler*" -type f 2>/dev/null || echo "No video_upscaler files found"
            exit 1
          fi
          
        elif [[ "${{ matrix.platform }}" == "windows" ]]; then
          if [[ -f "build/windows/x64/runner/Release/video_upscaler.exe" ]]; then
            echo "✅ Windows executable found"
            ls -lh build/windows/x64/runner/Release/video_upscaler.exe
          else
            echo "❌ Windows executable not found"
            echo "Available files:"
            find build/ -name "*video_upscaler*" -type f 2>/dev/null || echo "No video_upscaler files found"
            exit 1
          fi
          
        elif [[ "${{ matrix.platform }}" == "macos" ]]; then
          if [[ -d "build/macos/Build/Products/Release/video_upscaler.app" ]]; then
            echo "✅ macOS app bundle found"
            ls -la build/macos/Build/Products/Release/video_upscaler.app/Contents/MacOS/
          else
            echo "❌ macOS app bundle not found"
            echo "Available files:"
            find build/ -name "*video_upscaler*" 2>/dev/null || echo "No video_upscaler files found"
            exit 1
          fi
        fi
      shell: bash
    
    # PACKAGE APPLICATIONS
    - name: Package application
      run: |
        echo "Packaging application for ${{ matrix.platform }}..."
        
        if [[ "${{ matrix.platform }}" == "linux" ]]; then
          echo "Creating Linux package..."
          cd build/linux/x64/release/
          tar -czf ../../../../video_upscaler_linux_x64.tar.gz bundle/
          cd ../../../../
          echo "✅ Created video_upscaler_linux_x64.tar.gz"
          ls -lh video_upscaler_linux_x64.tar.gz
          
        elif [[ "${{ matrix.platform }}" == "windows" ]]; then
          echo "Creating Windows package..."
          cd build/windows/x64/runner/Release/
          7z a ../../../../../video_upscaler_windows_x64.zip * -r
          cd ../../../../../
          echo "✅ Created video_upscaler_windows_x64.zip"
          ls -lh video_upscaler_windows_x64.zip
          
        elif [[ "${{ matrix.platform }}" == "macos" ]]; then
          echo "Creating macOS package..."
          cd build/macos/Build/Products/Release/
          zip -r ../../../../../video_upscaler_macos.zip video_upscaler.app/
          cd ../../../../../
          echo "✅ Created video_upscaler_macos.zip"
          ls -lh video_upscaler_macos.zip
        fi
      shell: bash
    
    # UPLOAD BUILD ARTIFACTS
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: video-upscaler-${{ matrix.platform }}-build
        path: |
          build/${{ matrix.flutter-platform }}/
        retention-days: 30
        if-no-files-found: warn
    
    # UPLOAD PACKAGED ARTIFACTS
    - name: Upload packaged artifacts
      uses: actions/upload-artifact@v4
      with:
        name: video-upscaler-${{ matrix.platform }}-package
        path: |
          video_upscaler_*.tar.gz
          video_upscaler_*.zip
        retention-days: 90
        if-no-files-found: error
    
    # UPLOAD LOGS ON FAILURE
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ matrix.platform }}
        path: |
          *.log
          .dart_tool/
        retention-days: 7
        if-no-files-found: ignore

  # JOB ДЛЯ СОЗДАНИЯ RELEASE (при тегах)
  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all package artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: video-upscaler-*-package
        path: artifacts/
        merge-multiple: true
    
    - name: List downloaded artifacts
      run: |
        echo "Downloaded artifacts:"
        find artifacts/ -type f -ls
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: artifacts/*
        generate_release_notes: true
        draft: false
        prerelease: false
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
